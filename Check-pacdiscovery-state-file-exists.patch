From b6938f0246f38414f736fbaf0f77d73b8f29d417 Mon Sep 17 00:00:00 2001
From: Tudor Marcu <tudor.marcu@intel.com>
Date: Mon, 19 Oct 2015 14:27:02 -0700
Subject: [PATCH] Check the state file pacdiscovery sets

If pacdiscovery did not run, then Pacrunner has no proxy script, thus proxy
resolution will not work - so just ignore any dbus connection and run libcurl.

Signed-off-by: Tudor Marcu <tudor.marcu@intel.com>
---
 lib/url.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/lib/url.c b/lib/url.c
index befaa57..a625b69 100644
--- a/lib/url.c
+++ b/lib/url.c
@@ -83,6 +83,9 @@ int curl_win32_idn_to_ascii(const char *in, char **out);
 #include <dbus/dbus.h>
 #endif /* CURL_DISABLE_PROXY */
 
+#include <sys/stat.h>
+#define PROXY_STATE_FILE "/run/pacrunner/pac_active"
+
 #include "urldata.h"
 #include "netrc.h"
 
@@ -4465,6 +4468,7 @@ static char *detect_proxy(struct connectdata *conn, char *url)
    */
   char *no_proxy=NULL;
   char proxy_env[128];
+  struct stat sbuff;
 
   no_proxy=curl_getenv("no_proxy");
   if(!no_proxy)
@@ -4507,7 +4511,9 @@ static char *detect_proxy(struct connectdata *conn, char *url)
     if(prox)
       proxy = prox; /* use this */
 
-    if(!proxy) {
+    /* Check that no proxy is set AND that pacdiscovery has set pacrunner
+     * with a PAC script */
+    if(!proxy && stat(PROXY_STATE_FILE, &sbuff) == 0) {
       /* No protocol-specific proxy set in the environment.
        *     Fallback to pacrunner autoproxy lookup */
       autoproxy_ret = query_pacrunner_proxy(url,
-- 
2.5.0

